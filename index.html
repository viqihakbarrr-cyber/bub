<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Multiplayer Platformer 2D</title>
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
    <style>
        * { box-sizing: border-box; touch-action: none; user-select: none; -webkit-user-select: none; }
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; background-color: white; font-family: 'Arial', sans-serif; }
        
        /* CANVAS GAME */
        canvas { display: block; width: 100%; height: 100%; }

        /* UI LAYER */
        #ui-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; }
        
        /* LOBBY SCREEN */
        #lobby { 
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; 
            background: white; display: flex; flex-direction: column; 
            justify-content: center; align-items: center; pointer-events: auto; z-index: 10;
        }
        input { padding: 10px; font-size: 16px; margin: 10px; text-align: center; border: 2px solid #333; border-radius: 8px; width: 200px; }
        button { padding: 12px 24px; font-size: 18px; margin: 5px; background: #333; color: white; border: none; border-radius: 8px; cursor: pointer; }
        button:active { background: #555; }
        .hidden { display: none !important; }
        #status { margin-top: 10px; color: #666; font-size: 14px; }
        
        /* IN GAME HUD */
        #hud { position: absolute; top: 10px; left: 10px; z-index: 5; display: flex; gap: 20px; }
        .hp-container { width: 150px; height: 20px; background: #ddd; border: 2px solid #333; position: relative; }
        .hp-bar { width: 100%; height: 100%; background: #ff3333; transition: width 0.2s; }
        .name-tag { position: absolute; top: -20px; left: 0; font-weight: bold; color: #333; font-size: 12px; }

        /* CONTROLS */
        .controls-area { position: absolute; bottom: 20px; pointer-events: auto; display: flex; gap: 15px; }
        #controls-left { left: 20px; }
        #controls-right { right: 20px; }
        
        .btn { 
            width: 60px; height: 60px; background: rgba(0,0,0,0.1); 
            border: 2px solid #333; border-radius: 50%; 
            display: flex; justify-content: center; align-items: center; 
            font-weight: bold; font-size: 20px; color: #333;
        }
        .btn:active { background: rgba(0,0,0,0.3); }

        /* LOADING */
        #loader { position: absolute; top:0; left:0; width:100%; height:100%; background:white; z-index: 20; display:flex; justify-content:center; align-items:center; flex-direction: column;}
    </style>
</head>
<body>

    <div id="loader">
        <h2>Memuat Aset...</h2>
        <p id="load-progress">0%</p>
    </div>

    <div id="lobby">
        <h1>BATTLE 2D</h1>
        <input type="text" id="username" placeholder="Nama (Max 10)" maxlength="10">
        <div id="menu-buttons">
            <button onclick="startGame('host')">Buat Room</button>
            <button onclick="showJoin()">Gabung Room</button>
        </div>
        <div id="join-area" class="hidden">
            <input type="text" id="room-id-input" placeholder="Masukkan ID Room Teman">
            <button onclick="startGame('join')">Masuk</button>
            <button onclick="backToMenu()" style="background:#888;">Kembali</button>
        </div>
        <div id="waiting-area" class="hidden">
            <p>Menunggu lawan...</p>
            <p>Bagikan ID ini ke teman:</p>
            <h2 id="my-room-id" style="user-select: text; border: 1px dashed #333; padding: 5px;">...</h2>
        </div>
        <p id="status"></p>
    </div>

    <canvas id="gameCanvas"></canvas>

    <div id="ui-layer" class="hidden">
        <div id="hud">
            <div>
                <div class="name-tag" id="p1-name">Player 1</div>
                <div class="hp-container"><div class="hp-bar" id="p1-hp"></div></div>
            </div>
            <div id="p2-hud" style="opacity: 0.5;">
                <div class="name-tag" id="p2-name">Player 2</div>
                <div class="hp-container"><div class="hp-bar" id="p2-hp"></div></div>
            </div>
        </div>

        <div id="controls-left" class="controls-area">
            <div class="btn" id="btn-left">←</div>
            <div class="btn" id="btn-right">→</div>
        </div>
        <div id="controls-right" class="controls-area">
            <div class="btn" id="btn-dash" style="background:rgba(255, 200, 0, 0.2);">Dash</div>
            <div class="btn" id="btn-jump">Jump</div>
        </div>
    </div>

<script>
/**
 * KONFIGURASI DAN URL ASSET
 */
const ASSETS = {
    idle: [
        '0001_0.png','0002_8.png','0003_8.png','0004_9.png','0005_8.png','0006_8.png','0007_9.png','0008_8.png','0009_9.png','0010_9.png',
        '0011_8.png','0012_8.png','0013_9.png','0014_8.png','0015_8.png','0016_9.png','0017_8.png','0018_8.png','0019_9.png','0020_8.png'
    ].map(f => `https://raw.githubusercontent.com/viqihakbarrr-cyber/bub/main/Karakter/Kidle/${f}`),
    
    walk: [
        '0001_0.png','0002_8.png','0003_8.png','0004_9.png','0005_8.png','0006_8.png','0007_9.png','0008_8.png','0009_8.png','0010_9.png','0011_8.png'
    ].map(f => `https://raw.githubusercontent.com/viqihakbarrr-cyber/bub/main/Karakter/walk/${f}`),
    
    jump: [
        '0001_0.png','0002_8.png','0003_8.png'
    ].map(f => `https://raw.githubusercontent.com/viqihakbarrr-cyber/bub/main/Karakter/Jump/${f}`)
};

const sprites = { idle: [], walk: [], jump: [] };
let imagesLoaded = 0;
const totalImages = ASSETS.idle.length + ASSETS.walk.length + ASSETS.jump.length;

// Preload Images
function loadImages() {
    const loadGroup = (groupName, urls) => {
        urls.forEach(url => {
            const img = new Image();
            img.src = url;
            img.onload = () => {
                imagesLoaded++;
                document.getElementById('load-progress').innerText = Math.floor((imagesLoaded/totalImages)*100) + '%';
                if(imagesLoaded === totalImages) {
                    document.getElementById('loader').style.display = 'none';
                }
            };
            sprites[groupName].push(img);
        });
    };
    loadGroup('idle', ASSETS.idle);
    loadGroup('walk', ASSETS.walk);
    loadGroup('jump', ASSETS.jump);
}
loadImages();

/**
 * LOGIKA GAME & FISIKA
 */
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');

let screenWidth = window.innerWidth;
let screenHeight = window.innerHeight;
canvas.width = screenWidth;
canvas.height = screenHeight;

// Variabel Global
const GRAVITY = 0.8;
const FLOOR_Y = screenHeight - 50; // Lantai sedikit di atas bawah layar
const PLAYER_SIZE = 120; // Ukuran render karakter

// Input State
const keys = { left: false, right: false, jump: false, dash: false };

class Player {
    constructor(isLocal) {
        this.isLocal = isLocal;
        this.x = isLocal ? 100 : screenWidth - 200;
        this.y = FLOOR_Y - PLAYER_SIZE;
        this.vx = 0;
        this.vy = 0;
        this.width = PLAYER_SIZE;
        this.height = PLAYER_SIZE;
        this.speed = 5;
        this.jumpPower = -18;
        this.grounded = false;
        this.facingRight = isLocal; // P1 hadap kanan, P2 hadap kiri
        
        // Stats
        this.hp = 100;
        this.name = "Player";
        
        // Animasi
        this.state = 'idle'; // idle, walk, jump
        this.frame = 0;
        this.animTimer = 0;
        
        // Dash
        this.isDashing = false;
        this.dashCooldown = false;
        this.dashGhosts = []; // Array untuk after-image
    }

    update() {
        // Logika Fisika (Hanya dijalankan untuk Local Player, Remote Player menerima posisi dari update)
        if (this.isLocal) {
            // Horizontal Move
            if (keys.left) { this.vx = -this.speed; this.facingRight = false; this.state = 'walk'; }
            if (keys.right) { this.vx = this.speed; this.facingRight = true; this.state = 'walk'; }
            if (!keys.left && !keys.right) { this.vx = 0; this.state = 'idle'; }

            // Dash Logic
            if (keys.dash && !this.dashCooldown && !this.isDashing) {
                this.performDash();
            }

            // Apply Dash Velocity Override
            if (this.isDashing) {
                this.vx = this.facingRight ? 15 : -15; // Kecepatan Dash
                this.vy = 0; // Anti gravitasi saat dash
            } else {
                // Gravity
                this.vy += GRAVITY;
            }

            // Jump
            if (keys.jump && this.grounded && !this.isDashing) {
                this.vy = this.jumpPower;
                this.grounded = false;
                keys.jump = false; // Prevent hold jump
            }

            // Apply Velocity
            this.x += this.vx;
            this.y += this.vy;

            // Floor Collision
            if (this.y + this.height >= FLOOR_Y) {
                this.y = FLOOR_Y - this.height;
                this.vy = 0;
                this.grounded = true;
                if(this.vx === 0) this.state = 'idle';
            } else {
                this.grounded = false;
                if(!this.isDashing) this.state = 'jump';
            }

            // Boundary
            if (this.x < 0) this.x = 0;
            if (this.x > screenWidth - this.width) this.x = screenWidth - this.width;
        }

        // --- VISUAL & ANIMATION LOGIC (Berjalan untuk Local & Remote) ---

        // Update Frame Animasi
        this.animTimer++;
        let animSpeed = 3; // Makin kecil makin cepat
        if (this.state === 'walk') animSpeed = 2;
        if (this.state === 'jump') animSpeed = 5;

        if (this.animTimer % animSpeed === 0) {
            this.frame++;
        }

        // Loop Frame
        let maxFrame = sprites[this.state] ? sprites[this.state].length : 1;
        this.frame = this.frame % maxFrame;

        // Manage Dash Ghosts (After Image)
        // Hapus ghost yang sudah pudar
        for (let i = this.dashGhosts.length - 1; i >= 0; i--) {
            this.dashGhosts[i].opacity -= 0.02; // Pudar selama kira-kira 1 detik (60fps * 0.016)
            if (this.dashGhosts[i].opacity <= 0) {
                this.dashGhosts.splice(i, 1);
            }
        }

        // Generate Ghost baru jika sedang dashing
        if (this.isDashing || this.dashGhosts.length > 0) { 
             // Jika dashing, spawn ghost sering. Jika tidak, efek sisa.
             if(this.isDashing && this.animTimer % 3 === 0) {
                 this.addGhost();
             }
        }
    }

    performDash() {
        this.isDashing = true;
        this.dashCooldown = true;
        
        // Efek Dash Velocity sebentar (0.2s)
        setTimeout(() => {
            this.isDashing = false;
        }, 200);

        // Cooldown Dash (1s)
        setTimeout(() => {
            this.dashCooldown = false;
        }, 1000);
    }

    addGhost() {
        // Simpan snapshot tampilan saat ini
        let currentImg = sprites[this.state][this.frame] || sprites['idle'][0];
        this.dashGhosts.push({
            x: this.x,
            y: this.y,
            img: currentImg,
            facingRight: this.facingRight,
            opacity: 0.8
        });
    }

    draw(ctx) {
        // 1. Draw Ghosts (After Image)
        this.dashGhosts.forEach(g => {
            ctx.save();
            ctx.globalAlpha = g.opacity;
            if (!g.facingRight) {
                ctx.translate(g.x + this.width, g.y);
                ctx.scale(-1, 1);
                ctx.drawImage(g.img, 0, 0, this.width, this.height);
            } else {
                ctx.drawImage(g.img, g.x, g.y, this.width, this.height);
            }
            ctx.restore();
        });

        // 2. Draw Character
        ctx.save();
        let currentSpriteArr = sprites[this.state];
        if (!currentSpriteArr || currentSpriteArr.length === 0) currentSpriteArr = sprites['idle'];
        
        let img = currentSpriteArr[this.frame];
        if (!img) img = sprites['idle'][0];

        if (!this.facingRight) {
            ctx.translate(this.x + this.width, this.y);
            ctx.scale(-1, 1);
            ctx.drawImage(img, 0, 0, this.width, this.height);
        } else {
            ctx.drawImage(img, this.x, this.y, this.width, this.height);
        }
        ctx.restore();
    }
}

// Inisialisasi Player
const p1 = new Player(true); // Saya
const p2 = new Player(false); // Lawan

/**
 * MULTIPLAYER LOGIC (PeerJS)
 */
let peer = null;
let conn = null;
let isHost = false;

function initPeer(mode) {
    const name = document.getElementById('username').value || "Player";
    p1.name = name;
    document.getElementById('p1-name').innerText = name;

    // Buat Peer ID acak
    peer = new Peer(); 

    peer.on('open', (id) => {
        console.log('My peer ID is: ' + id);
        if (mode === 'host') {
            document.getElementById('waiting-area').classList.remove('hidden');
            document.getElementById('menu-buttons').classList.add('hidden');
            document.getElementById('my-room-id').innerText = id;
            isHost = true;
        } else if (mode === 'join') {
            const hostId = document.getElementById('room-id-input').value;
            connectToPeer(hostId);
        }
    });

    peer.on('connection', (c) => {
        // Host menerima koneksi
        conn = c;
        setupConnection();
        document.getElementById('lobby').classList.add('hidden');
        document.getElementById('ui-layer').classList.remove('hidden');
        startGameLoop();
    });
}

function connectToPeer(id) {
    if (!id) return alert("Masukkan ID Room");
    conn = peer.connect(id);
    conn.on('open', () => {
        setupConnection();
        document.getElementById('lobby').classList.add('hidden');
        document.getElementById('ui-layer').classList.remove('hidden');
        startGameLoop();
    });
}

function setupConnection() {
    // Kirim data nama awal
    conn.send({ type: 'init', name: p1.name });

    conn.on('data', (data) => {
        if (data.type === 'init') {
            p2.name = data.name;
            document.getElementById('p2-name').innerText = p2.name;
            document.getElementById('p2-hud').style.opacity = "1";
        }
        if (data.type === 'update') {
            // Update posisi P2 berdasarkan data jaringan
            p2.x = data.x;
            p2.y = data.y;
            p2.state = data.state;
            p2.facingRight = data.facingRight;
            
            // Trigger visual dash ghost di remote player jika state mereka berubah
            if(data.isDashing && !p2.isDashing) {
                p2.performDash(); 
            }
            p2.hp = data.hp;
        }
    });
}

// Kirim data setiap frame (atau interval tertentu)
function sendData() {
    if (conn && conn.open) {
        conn.send({
            type: 'update',
            x: p1.x,
            y: p1.y,
            state: p1.state,
            facingRight: p1.facingRight,
            isDashing: p1.isDashing,
            hp: p1.hp
        });
    }
}

/**
 * UI LOGIC
 */
function showJoin() {
    document.getElementById('menu-buttons').classList.add('hidden');
    document.getElementById('join-area').classList.remove('hidden');
}

function backToMenu() {
    document.getElementById('join-area').classList.add('hidden');
    document.getElementById('menu-buttons').classList.remove('hidden');
}

function startGame(mode) {
    if(!document.getElementById('username').value) {
        alert("Isi nama dulu!");
        return;
    }
    initPeer(mode);
}

/**
 * CONTROLS (TOUCH)
 */
const setupBtn = (id, key) => {
    const el = document.getElementById(id);
    el.addEventListener('touchstart', (e) => { e.preventDefault(); keys[key] = true; });
    el.addEventListener('touchend', (e) => { e.preventDefault(); keys[key] = false; });
    el.addEventListener('mousedown', (e) => { keys[key] = true; });
    el.addEventListener('mouseup', (e) => { keys[key] = false; });
};

setupBtn('btn-left', 'left');
setupBtn('btn-right', 'right');
setupBtn('btn-jump', 'jump');
setupBtn('btn-dash', 'dash');

/**
 * MAIN LOOP
 */
function gameLoop() {
    // Clear Canvas (White)
    ctx.fillStyle = 'white';
    ctx.fillRect(0, 0, canvas.width, canvas.height);
    
    // Draw Floor Line (Optional visual, since background is same white)
    // Tapi user minta lantai warna sama dengan background, jadi invisible.
    // Kita gambar bayangan tipis saja biar tau ada lantai
    ctx.fillStyle = '#f9f9f9'; 
    ctx.fillRect(0, FLOOR_Y, canvas.width, screenHeight - FLOOR_Y);

    // Update & Draw P1
    p1.update();
    p1.draw(ctx);

    // Update & Draw P2
    p2.update(); // Hanya update animasi/ghost, posisi dari network
    p2.draw(ctx);

    // Network Sync
    sendData();

    // Update HP UI
    document.getElementById('p1-hp').style.width = p1.hp + '%';
    document.getElementById('p2-hp').style.width = p2.hp + '%';

    requestAnimationFrame(gameLoop);
}

function startGameLoop() {
    requestAnimationFrame(gameLoop);
}

// Resize handle
window.addEventListener('resize', () => {
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;
    screenWidth = canvas.width;
    screenHeight = canvas.height;
});

</script>
</body>
</html>
