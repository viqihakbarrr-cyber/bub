<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>2D Multiplayer Platformer</title>
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            touch-action: none; /* Mencegah zoom/scroll pada mobile */
            user-select: none;
        }

        body {
            background-color: #ffffff; /* Putih Polos */
            overflow: hidden;
            font-family: 'Arial', sans-serif;
            color: #333;
        }

        /* LOBBY UI */
        #lobby {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: white;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 100;
        }

        .lobby-box {
            background: #f0f0f0;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            width: 80%;
            max-width: 400px;
        }

        input {
            padding: 10px;
            font-size: 18px;
            width: 100%;
            margin: 10px 0;
            text-align: center;
            border: 1px solid #ccc;
            border-radius: 5px;
        }

        button {
            padding: 10px 20px;
            font-size: 18px;
            background: #333;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
            width: 100%;
        }

        button:active { background: #555; }

        /* GAME UI */
        #gameUI {
            display: none; /* Hidden by default */
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none; /* Biar tembus ke canvas */
        }

        canvas {
            display: block;
        }

        /* HP BAR */
        #hpContainer {
            position: absolute;
            top: 10px;
            left: 10px;
            width: 200px;
            height: 20px;
            background: #ddd;
            border: 2px solid #333;
        }

        #hpBar {
            width: 100%;
            height: 100%;
            background: #ff4444;
        }

        /* CONTROLS */
        .control-area {
            position: absolute;
            bottom: 20px;
            pointer-events: auto;
            display: flex;
            gap: 15px;
        }

        .left-controls {
            left: 20px;
        }

        .right-controls {
            right: 20px;
        }

        .btn {
            width: 60px;
            height: 60px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 50%;
            border: 2px solid #333;
            display: flex;
            justify-content: center;
            align-items: center;
            font-weight: bold;
            font-size: 24px;
            color: #333;
        }

        .btn:active {
            background: rgba(0, 0, 0, 0.5);
            color: white;
        }

        /* Notifikasi */
        #statusMsg {
            margin-bottom: 10px;
            font-weight: bold;
            color: red;
        }
    </style>
</head>
<body>

    <div id="lobby">
        <div class="lobby-box">
            <h2>2D Platformer Multiplayer</h2>
            <p id="statusMsg">Siap terhubung...</p>
            
            <div id="createSection">
                <button onclick="createRoom()">Create Room</button>
            </div>
            
            <div style="margin: 15px 0; font-weight: bold;">OR</div>
            
            <div id="joinSection">
                <input type="number" id="roomInput" placeholder="Masukkan 6 Digit Kode" maxlength="6">
                <button onclick="joinRoom()">Join Room</button>
            </div>

            <div id="roomInfo" style="display:none; margin-top:15px;">
                <p>Kode Room:</p>
                <h1 id="displayCode" style="letter-spacing: 5px; font-size: 32px;"></h1>
                <p>Menunggu Player 2...</p>
            </div>
        </div>
    </div>

    <canvas id="gameCanvas"></canvas>

    <div id="gameUI">
        <div id="hpContainer"><div id="hpBar"></div></div>

        <div class="control-area left-controls">
            <div class="btn" id="btnLeft">←</div>
            <div class="btn" id="btnRight">→</div>
        </div>

        <div class="control-area right-controls">
            <div class="btn" id="btnDash" style="background:rgba(255, 165, 0, 0.3)">⚡</div>
            <div class="btn" id="btnJump">↑</div>
        </div>
    </div>

    <script>
        // --- KONFIGURASI ASET ---
        const ASSETS = {
            idle: [
                "https://raw.githubusercontent.com/viqihakbarrr-cyber/bub/main/Karakter/Kidle/0001_0.png",
                "https://raw.githubusercontent.com/viqihakbarrr-cyber/bub/main/Karakter/Kidle/0002_8.png",
                "https://raw.githubusercontent.com/viqihakbarrr-cyber/bub/main/Karakter/Kidle/0003_8.png",
                "https://raw.githubusercontent.com/viqihakbarrr-cyber/bub/main/Karakter/Kidle/0004_9.png",
                "https://raw.githubusercontent.com/viqihakbarrr-cyber/bub/main/Karakter/Kidle/0005_8.png",
                "https://raw.githubusercontent.com/viqihakbarrr-cyber/bub/main/Karakter/Kidle/0006_8.png",
                "https://raw.githubusercontent.com/viqihakbarrr-cyber/bub/main/Karakter/Kidle/0007_9.png",
                "https://raw.githubusercontent.com/viqihakbarrr-cyber/bub/main/Karakter/Kidle/0008_8.png",
                "https://raw.githubusercontent.com/viqihakbarrr-cyber/bub/main/Karakter/Kidle/0009_9.png",
                "https://raw.githubusercontent.com/viqihakbarrr-cyber/bub/main/Karakter/Kidle/0010_9.png",
                "https://raw.githubusercontent.com/viqihakbarrr-cyber/bub/main/Karakter/Kidle/0011_8.png",
                "https://raw.githubusercontent.com/viqihakbarrr-cyber/bub/main/Karakter/Kidle/0012_8.png",
                "https://raw.githubusercontent.com/viqihakbarrr-cyber/bub/main/Karakter/Kidle/0013_9.png",
                "https://raw.githubusercontent.com/viqihakbarrr-cyber/bub/main/Karakter/Kidle/0014_8.png",
                "https://raw.githubusercontent.com/viqihakbarrr-cyber/bub/main/Karakter/Kidle/0015_8.png",
                "https://raw.githubusercontent.com/viqihakbarrr-cyber/bub/main/Karakter/Kidle/0016_9.png",
                "https://raw.githubusercontent.com/viqihakbarrr-cyber/bub/main/Karakter/Kidle/0017_8.png",
                "https://raw.githubusercontent.com/viqihakbarrr-cyber/bub/main/Karakter/Kidle/0018_8.png",
                "https://raw.githubusercontent.com/viqihakbarrr-cyber/bub/main/Karakter/Kidle/0019_9.png",
                "https://raw.githubusercontent.com/viqihakbarrr-cyber/bub/main/Karakter/Kidle/0020_8.png"
            ],
            walk: [
                "https://raw.githubusercontent.com/viqihakbarrr-cyber/bub/main/Karakter/walk/0001_0.png",
                "https://raw.githubusercontent.com/viqihakbarrr-cyber/bub/main/Karakter/walk/0002_8.png",
                "https://raw.githubusercontent.com/viqihakbarrr-cyber/bub/main/Karakter/walk/0003_8.png",
                "https://raw.githubusercontent.com/viqihakbarrr-cyber/bub/main/Karakter/walk/0004_9.png",
                "https://raw.githubusercontent.com/viqihakbarrr-cyber/bub/main/Karakter/walk/0005_8.png",
                "https://raw.githubusercontent.com/viqihakbarrr-cyber/bub/main/Karakter/walk/0006_8.png",
                "https://raw.githubusercontent.com/viqihakbarrr-cyber/bub/main/Karakter/walk/0007_9.png",
                "https://raw.githubusercontent.com/viqihakbarrr-cyber/bub/main/Karakter/walk/0008_8.png",
                "https://raw.githubusercontent.com/viqihakbarrr-cyber/bub/main/Karakter/walk/0009_8.png",
                "https://raw.githubusercontent.com/viqihakbarrr-cyber/bub/main/Karakter/walk/0010_9.png",
                "https://raw.githubusercontent.com/viqihakbarrr-cyber/bub/main/Karakter/walk/0011_8.png"
            ],
            jump: [
                "https://raw.githubusercontent.com/viqihakbarrr-cyber/bub/main/Karakter/Jump/0001_0.png",
                "https://raw.githubusercontent.com/viqihakbarrr-cyber/bub/main/Karakter/Jump/0002_8.png",
                "https://raw.githubusercontent.com/viqihakbarrr-cyber/bub/main/Karakter/Jump/0003_8.png"
            ]
        };

        // Preload Images
        const loadedImages = { idle: [], walk: [], jump: [] };
        function preloadImages() {
            for (let key in ASSETS) {
                ASSETS[key].forEach(url => {
                    const img = new Image();
                    img.src = url;
                    loadedImages[key].push(img);
                });
            }
        }
        preloadImages();

        // --- GAME ENGINE & LOGIC ---
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        
        // Resize Canvas
        function resize() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
        }
        window.addEventListener('resize', resize);
        resize();

        // Constants
        const GRAVITY = 0.8;
        const FLOOR_Y = window.innerHeight - 150; // Lantai invisible
        const SPEED = 5;
        const JUMP_FORCE = -15;
        const DASH_FORCE = 15;
        const DASH_DURATION = 1000; // 1 detik (ms)

        // Inputs
        const keys = { left: false, right: false, jump: false, dash: false };

        // Helper untuk UI Touch
        function setupTouch(id, key) {
            const el = document.getElementById(id);
            el.addEventListener('touchstart', (e) => { e.preventDefault(); keys[key] = true; });
            el.addEventListener('touchend', (e) => { e.preventDefault(); keys[key] = false; });
            el.addEventListener('mousedown', (e) => { keys[key] = true; });
            el.addEventListener('mouseup', (e) => { keys[key] = false; });
        }
        setupTouch('btnLeft', 'left');
        setupTouch('btnRight', 'right');
        setupTouch('btnJump', 'jump');
        setupTouch('btnDash', 'dash');

        // Class Player
        class Player {
            constructor(isLocal = true, x = 100) {
                this.isLocal = isLocal;
                this.x = x;
                this.y = FLOOR_Y;
                this.vx = 0;
                this.vy = 0;
                this.width = 100; // Sesuaikan ukuran sprite
                this.height = 100;
                this.facingRight = true;
                
                this.state = 'idle'; // idle, walk, jump
                this.frameIndex = 0;
                this.frameTimer = 0;
                this.animSpeed = 5; // Semakin kecil semakin cepat

                // Dash Mechanics
                this.isDashing = false;
                this.dashEndTime = 0;
                this.ghosts = []; // Array untuk after image
            }

            update() {
                // Update State & Physics (Hanya Local Player yang menghitung fisik sendiri)
                if (this.isLocal) {
                    this.handleInput();
                    this.physics();
                } else {
                    // Remote player positions are interpolated/set via network
                    this.animate(); // Tetap jalankan animasi
                }

                // Update Ghosts (After Image)
                if (Date.now() < this.dashEndTime) {
                    // Tambah ghost setiap beberapa frame
                    if (this.frameTimer % 3 === 0) {
                        this.ghosts.push({
                            x: this.x,
                            y: this.y,
                            alpha: 0.8,
                            img: this.getCurrentSprite(),
                            facingRight: this.facingRight
                        });
                    }
                }
                
                // Kurangi opacity ghost
                for (let i = this.ghosts.length - 1; i >= 0; i--) {
                    this.ghosts[i].alpha -= 0.05;
                    if (this.ghosts[i].alpha <= 0) this.ghosts.splice(i, 1);
                }
            }

            handleInput() {
                // Movement
                if (keys.left) {
                    this.vx = -SPEED;
                    this.facingRight = false;
                    if (!this.isDashing) this.state = 'walk';
                } else if (keys.right) {
                    this.vx = SPEED;
                    this.facingRight = true;
                    if (!this.isDashing) this.state = 'walk';
                } else {
                    this.vx = 0;
                    if (!this.isDashing && this.y >= FLOOR_Y) this.state = 'idle';
                }

                // Jump
                if (keys.jump && this.y >= FLOOR_Y) {
                    this.vy = JUMP_FORCE;
                    this.state = 'jump';
                }

                // Dash
                if (keys.dash && Date.now() > this.dashEndTime) {
                    this.isDashing = true;
                    this.dashEndTime = Date.now() + DASH_DURATION;
                    // Dash boost
                    let dashDir = this.facingRight ? 1 : -1;
                    if (keys.left) dashDir = -1;
                    if (keys.right) dashDir = 1;
                    
                    this.vx = dashDir * DASH_FORCE;
                    this.vy = 0; // Tahan gravity sedikit saat dash start (opsional)
                }

                // Jika masa dash habis tapi efek masih jalan (1 detik)
                if (Date.now() > this.dashEndTime - DASH_DURATION + 200) {
                     this.isDashing = false; // Stop movement lock setelah 0.2s, tapi efek visual lanjut
                }
            }

            physics() {
                this.x += this.vx;
                this.y += this.vy;

                // Gravity
                if (this.y < FLOOR_Y) {
                    this.vy += GRAVITY;
                    if(!this.isDashing) this.state = 'jump';
                } else {
                    this.y = FLOOR_Y;
                    this.vy = 0;
                    if (this.vx === 0) this.state = 'idle';
                }

                // Animasi Frame Counter
                this.animate();

                // Batas layar
                if (this.x < 0) this.x = 0;
                if (this.x > canvas.width - this.width) this.x = canvas.width - this.width;
            }

            animate() {
                this.frameTimer++;
                if (this.frameTimer >= this.animSpeed) {
                    this.frameTimer = 0;
                    this.frameIndex++;
                }
            }

            getCurrentSprite() {
                // Pilih array gambar berdasarkan state
                let sprites = loadedImages.idle;
                if (this.state === 'walk') sprites = loadedImages.walk;
                if (this.state === 'jump') sprites = loadedImages.jump;

                // Loop frame
                let idx = this.frameIndex % sprites.length;
                return sprites[idx];
            }

            draw(ctx) {
                // 1. Gambar Ghosts (After Image)
                this.ghosts.forEach(g => {
                    ctx.save();
                    ctx.globalAlpha = g.alpha;
                    ctx.translate(g.x + this.width / 2, g.y + this.height / 2);
                    if (!g.facingRight) ctx.scale(-1, 1);
                    ctx.drawImage(g.img, -this.width / 2, -this.height / 2, this.width, this.height);
                    ctx.restore();
                });

                // 2. Gambar Karakter Utama
                let img = this.getCurrentSprite();
                if (!img) return;

                ctx.save();
                ctx.translate(this.x + this.width / 2, this.y + this.height / 2);
                if (!this.facingRight) ctx.scale(-1, 1); // Flip horizontal
                ctx.drawImage(img, -this.width / 2, -this.height / 2, this.width, this.height);
                ctx.restore();
            }

            // Untuk multiplayer data
            getData() {
                return {
                    x: this.x,
                    y: this.y,
                    state: this.state,
                    facingRight: this.facingRight,
                    dashActive: (Date.now() < this.dashEndTime)
                };
            }

            setData(data) {
                this.x = data.x;
                this.y = data.y;
                this.state = data.state;
                this.facingRight = data.facingRight;
                if (data.dashActive) {
                    this.dashEndTime = Date.now() + 500; // Sync visual dash
                }
            }
        }

        // --- MULTIPLAYER LOGIC (PEERJS) ---
        let peer;
        let conn;
        let isHost = false;
        
        const localPlayer = new Player(true, 50);
        const remotePlayer = new Player(false, 200);
        let gameActive = false;

        function initPeer() {
            peer = new Peer(null, {
                debug: 2
            });

            peer.on('open', (id) => {
                console.log('My peer ID is: ' + id);
            });

            peer.on('connection', (c) => {
                // Host menerima koneksi
                conn = c;
                setupConnection();
            });

            peer.on('error', (err) => {
                alert("Error Koneksi: " + err);
            });
        }

        function createRoom() {
            // Generate 6 digit code
            const code = Math.floor(100000 + Math.random() * 900000);
            const roomId = "game-platformer-" + code;
            
            peer = new Peer(roomId);

            peer.on('open', (id) => {
                document.getElementById('createSection').style.display = 'none';
                document.getElementById('joinSection').style.display = 'none';
                document.getElementById('roomInfo').style.display = 'block';
                document.getElementById('displayCode').innerText = code;
                document.getElementById('statusMsg').innerText = "Menunggu lawan...";
                isHost = true;
            });

            peer.on('connection', (c) => {
                conn = c;
                setupConnection();
            });
        }

        function joinRoom() {
            const code = document.getElementById('roomInput').value;
            if (code.length !== 6) {
                alert("Masukkan 6 digit kode!");
                return;
            }
            
            const roomId = "game-platformer-" + code;
            peer = new Peer(); // Client pake ID random

            peer.on('open', (id) => {
                conn = peer.connect(roomId);
                setupConnection();
            });
            
            peer.on('error', (err) => {
                alert("Room tidak ditemukan!");
            });
        }

        function setupConnection() {
            conn.on('open', () => {
                console.log("Connected!");
                document.getElementById('lobby').style.display = 'none';
                document.getElementById('gameUI').style.display = 'block';
                gameActive = true;
                startGame();
            });

            conn.on('data', (data) => {
                // Terima data posisi lawan
                remotePlayer.setData(data);
            });
        }

        // --- GAME LOOP ---
        function startGame() {
            function loop() {
                ctx.clearRect(0, 0, canvas.width, canvas.height);

                // Background & Floor (Putih)
                ctx.fillStyle = "white";
                ctx.fillRect(0, 0, canvas.width, canvas.height);

                // Local Player Logic
                localPlayer.update();
                localPlayer.draw(ctx);

                // Remote Player Logic
                remotePlayer.update(); // Hanya update animasi/ghost, bukan fisik
                remotePlayer.draw(ctx);

                // Kirim data ke lawan
                if (gameActive && conn && conn.open) {
                    conn.send(localPlayer.getData());
                }

                requestAnimationFrame(loop);
            }
            loop();
        }

        // Init tombol
        // initPeer(); // Pindah ke tombol
    </script>
</body>
</html>
