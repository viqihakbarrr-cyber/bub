<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Samurai Predict - Multiplayer</title>
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Shojumaru&family=Roboto:wght@400;700&display=swap');

        :root {
            --bg-url: url('https://raw.githubusercontent.com/viqihakbarrr-cyber/bub/main/Samu/Sbg.jpg');
            --glow-owner: 0 0 15px 3px rgba(0, 191, 255, 0.9);
            --glow-enemy: 0 0 15px 3px rgba(255, 50, 50, 0.9);
            --bar-height: 16px; /* Bar lebih tipis */
        }

        * { box-sizing: border-box; }

        body {
            margin: 0; padding: 0;
            overflow: hidden;
            background: black;
            font-family: 'Roboto', sans-serif;
            color: white;
            user-select: none;
            -webkit-user-select: none; /* Cegah zoom/select di mobile */
            touch-action: manipulation;
        }

        #game-container {
            position: relative;
            width: 100vw; height: 100vh;
            background-image: var(--bg-url);
            background-size: cover;
            background-position: center;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }

        /* --- LOBBY SCREEN --- */
        #lobby-screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9);
            display: flex; flex-direction: column;
            justify-content: center; align-items: center;
            z-index: 100;
        }
        h1 { font-family: 'Shojumaru', cursive; color: #ffcc00; font-size: 1.8rem; text-align: center; margin-bottom: 30px; }
        .btn {
            background: #8b0000; color: white; border: 2px solid #ffcc00;
            padding: 12px 30px; margin: 10px; font-size: 1rem; border-radius: 5px;
            font-family: 'Shojumaru', cursive; cursor: pointer;
        }
        input { padding: 10px; font-size: 1.2rem; text-align: center; width: 120px; border-radius: 5px; border: none; }

        /* --- HUD (HEADS UP DISPLAY) --- */
        #hud-area {
            width: 100%;
            padding: 10px;
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            background: linear-gradient(to bottom, rgba(0,0,0,0.8), transparent);
            z-index: 10;
        }

        .player-hud {
            width: 45%; /* Flexible width */
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .hud-name {
            font-size: 0.8rem; font-weight: bold; color: #ffcc00; text-shadow: 1px 1px black;
            margin-bottom: 2px;
        }

        .bar-wrapper {
            position: relative;
            width: 100%;
            height: var(--bar-height);
            background: #222;
            border: 1px solid #555;
            border-radius: 3px;
            overflow: hidden;
        }

        .bar-fill { height: 100%; transition: width 0.3s ease-out; }
        .hp-fill { background: linear-gradient(90deg, #00b300, #00ff00); }
        .kt-fill { background: linear-gradient(90deg, #0080ff, #00bfff); }

        /* Teks di dalam bar (Overlay) */
        .bar-text {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            display: flex; align-items: center; justify-content: center;
            font-size: 10px; font-weight: bold; text-shadow: 1px 1px 2px black;
            z-index: 2;
        }

        /* --- ARENA AREA --- */
        #arena-container {
            flex-grow: 1; /* Isi sisa ruang tengah */
            position: relative;
            width: 100%;
            overflow: hidden;
        }

        #arena-grid {
            position: absolute;
            bottom: 20px; /* Jarak dari area tombol */
            left: 5%; width: 90%; height: 180px;
            display: flex; justify-content: space-between; align-items: flex-end;
        }
        
        .grid-slot { width: 18%; height: 100%; position: relative; }

        .character {
            width: 100%; height: 100%;
            background-size: contain; background-repeat: no-repeat;
            background-position: bottom center;
            position: absolute; bottom: 0; left: 0;
            transition: transform 0.1s;
        }
        .owner { filter: drop-shadow(var(--glow-owner)); }
        .enemy { filter: drop-shadow(var(--glow-enemy)); transform: scaleX(-1); }

        /* FX */
        #fx-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; z-index: 50;
            display: flex; justify-content: center; align-items: center;
        }
        .spark {
            width: 150px; height: 150px;
            background-image: url('https://raw.githubusercontent.com/viqihakbarrr-cyber/bub/main/Samu/Spark.png');
            background-size: contain; background-repeat: no-repeat;
            opacity: 0; transform: scale(0.5); transition: all 0.1s;
        }
        .spark.active { opacity: 0.9; transform: scale(1.2); }

        /* --- CONTROLS AREA (FLEXIBLE) --- */
        #controls-area {
            width: 100%;
            padding: 10px 10px 20px 10px; /* Padding bawah lebih besar untuk HP layar penuh */
            background: linear-gradient(to top, rgba(0,0,0,0.9), transparent);
            display: flex;
            flex-direction: column;
            align-items: center;
            z-index: 20;
        }

        #sequence-display {
            font-size: 0.9rem; color: #ffff00; text-align: center; margin-bottom: 8px;
            min-height: 1.2rem;
        }

        #buttons-row {
            display: flex;
            width: 100%;
            justify-content: space-between;
            gap: 8px; /* Jarak antar tombol */
            max-width: 600px; /* Batas lebar di tablet */
        }

        .move-btn {
            flex: 1; /* Flexible width: semua tombol berbagi ruang sama rata */
            aspect-ratio: 1/1; /* Agar tombol tetap kotak proporsional */
            max-height: 70px; /* Maksimal tinggi */
            background: #222; border: 2px solid #555; border-radius: 8px;
            color: white; font-size: 0.7rem; font-weight: bold;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            cursor: pointer; touch-action: manipulation;
            position: relative;
        }
        
        .move-btn img { 
            width: 50%; height: 50%; object-fit: contain; margin-bottom: 4px; 
            pointer-events: none; 
            /* Placeholder icon kalau gambar belum load */
            background: rgba(255,255,255,0.1); border-radius: 50%;
        }

        .move-btn.selected { 
            background: #0080ff; border-color: white; color: white; opacity: 0.6; 
        }
        .move-btn:active { transform: scale(0.95); background: #444; }

        /* Icon teks sederhana karena tidak ada aset icon spesifik */
        .icon-text { font-size: 1.2rem; margin-bottom: 2px; }

        #game-message {
            position: absolute; top: 40%; width: 100%;
            text-align: center; font-size: 1.5rem; color: white;
            text-shadow: 0 0 10px black; pointer-events: none; z-index: 99;
            font-family: 'Shojumaru', cursive; padding: 0 20px;
        }

    </style>
</head>
<body>

<div id="game-container">
    
    <div id="lobby-screen">
        <h1>SAMURAI PREDICT</h1>
        <button class="btn" onclick="createRoom()">BUAT ROOM</button>
        <div style="margin-top:20px; text-align: center;">
            <input type="number" id="room-code-input" placeholder="KODE" maxlength="4">
            <br>
            <button class="btn" onclick="joinRoom()" style="margin-top: 10px;">GABUNG ROOM</button>
        </div>
        <p id="lobby-status" style="color: cyan; margin-top: 15px; font-size: 0.9rem;"></p>
    </div>

    <div id="game-ui" style="display: none; width: 100%; height: 100%; display: flex; flex-direction: column;">
        
        <div id="hud-area">
            <div class="player-hud" id="hud-left">
                <div class="hud-name" id="name-p1">KAMU</div>
                <div class="bar-wrapper">
                    <div class="bar-fill hp-fill" id="p1-hp-bar" style="width: 100%;"></div>
                    <span class="bar-text" id="p1-hp-text">100 / 100</span>
                </div>
                <div class="bar-wrapper" style="margin-top: 3px;">
                    <div class="bar-fill kt-fill" id="p1-kt-bar" style="width: 100%;"></div>
                    <span class="bar-text" id="p1-kt-text">Pedang: 100%</span>
                </div>
            </div>

            <div class="player-hud" id="hud-right" style="align-items: flex-end;">
                <div class="hud-name" id="name-p2" style="color: #ff5555;">MUSUH</div>
                <div class="bar-wrapper">
                    <div class="bar-fill hp-fill" id="p2-hp-bar" style="width: 100%;"></div>
                    <span class="bar-text" id="p2-hp-text">100 / 100</span>
                </div>
                <div class="bar-wrapper" style="margin-top: 3px;">
                    <div class="bar-fill kt-fill" id="p2-kt-bar" style="width: 100%;"></div>
                    <span class="bar-text" id="p2-kt-text">Pedang: 100%</span>
                </div>
            </div>
        </div>

        <div id="arena-container">
            <div id="fx-layer"><div class="spark" id="spark-fx"></div></div>
            <div id="game-message"></div>
            
            <div id="arena-grid">
                <div class="grid-slot" id="grid-1"></div>
                <div class="grid-slot" id="grid-2"></div>
                <div class="grid-slot" id="grid-3"></div>
                <div class="grid-slot" id="grid-4"></div>
                <div class="grid-slot" id="grid-5"></div>
            </div>
        </div>

        <div id="controls-area">
            <div id="sequence-display">Urutan: <span id="move-seq-text" style="color:white;">...</span></div>
            <div id="buttons-row">
                <div class="move-btn" id="btn-maju" onclick="selectMove('maju')">
                    <span class="icon-text">‚è©</span>MAJU
                </div>
                <div class="move-btn" id="btn-attack" onclick="selectMove('attack')">
                    <span class="icon-text">‚öîÔ∏è</span>ATTACK
                </div>
                <div class="move-btn" id="btn-tangkis" onclick="selectMove('tangkis')">
                    <span class="icon-text">üõ°Ô∏è</span>TANGKIS
                </div>
                <div class="move-btn" id="btn-mundur" onclick="selectMove('mundur')">
                    <span class="icon-text">‚è™</span>MUNDUR
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    /* --- CONFIG & ASSETS --- */
    const ASSETS = {
        idle: 'https://raw.githubusercontent.com/viqihakbarrr-cyber/bub/main/Samu/Sidle.png',
        maju: 'https://raw.githubusercontent.com/viqihakbarrr-cyber/bub/main/Samu/Smaju.png',
        mundur: 'https://raw.githubusercontent.com/viqihakbarrr-cyber/bub/main/Samu/Smundur.png',
        attack: 'https://raw.githubusercontent.com/viqihakbarrr-cyber/bub/main/Samu/Sattack.png',
        tangkis: 'https://raw.githubusercontent.com/viqihakbarrr-cyber/bub/main/Samu/Stangkis.png'
    };

    /* --- GAME VARIABLES --- */
    let peer, conn, isHost = false, myId = null;
    let p1Stats = { hp: 100, katana: 100, pos: 2 }; 
    let p2Stats = { hp: 100, katana: 100, pos: 4 }; 
    let myMoves = [], enemyMoves = null, turnInProgress = false;

    // DOM Elements
    const lobbyStatus = document.getElementById('lobby-status');
    const msgEl = document.getElementById('game-message');
    const sparkEl = document.getElementById('spark-fx');

    /* --- PEERJS CONNECTION --- */
    function initPeer(id) {
        peer = new Peer('samu-v2-' + id); // Prefix v2 untuk versi baru

        peer.on('open', (id) => {
            myId = id;
            if(isHost) {
                lobbyStatus.innerHTML = `Kode Room: <b style="font-size:1.5rem; color:yellow;">${id.split('-')[2]}</b><br>Menunggu lawan...`;
            }
        });

        peer.on('connection', (c) => {
            if (isHost && !conn) {
                conn = c; setupConnection(); startGame();
            }
        });

        peer.on('error', (err) => {
            lobbyStatus.innerText = "Error / Kode Terpakai. Coba lagi.";
        });
    }

    function createRoom() {
        const code = Math.floor(1000 + Math.random() * 9000);
        isHost = true;
        initPeer(code);
    }

    function joinRoom() {
        const code = document.getElementById('room-code-input').value;
        if (code.length !== 4) return alert("Isi 4 digit kode");
        isHost = false;
        const clientId = Math.floor(10000 + Math.random() * 90000);
        peer = new Peer('samu-client-v2-' + clientId);
        peer.on('open', () => {
            conn = peer.connect('samu-v2-' + code);
            setupConnection();
        });
        peer.on('error', () => alert("Gagal konek. Cek kode."));
    }

    function setupConnection() {
        conn.on('open', () => {
            if(!isHost) startGame();
        });
        conn.on('data', (data) => {
            if (data.type === 'moves') {
                enemyMoves = data.moves;
                checkTurnReady();
            }
        });
    }

    /* --- GAMEPLAY LOGIC --- */
    function startGame() {
        document.getElementById('lobby-screen').style.display = 'none';
        document.getElementById('game-ui').style.removeProperty('display'); // Show Flex
        
        // Atur Nama HUD
        if(isHost) {
            document.getElementById('name-p1').innerText = "KAMU (OWNER)";
            document.getElementById('name-p2').innerText = "LAWAN";
        } else {
            // Di layar Client, P1 (Kiri Visual) adalah Client (Dirinya), P2 (Kanan Visual) adalah Host (Musuh)
            // Tapi data p1Stats tetap Host, p2Stats tetap Client. Rendering akan membalik ini.
            document.getElementById('name-p1').innerText = "KAMU";
            document.getElementById('name-p2').innerText = "LAWAN (OWNER)";
        }

        resetRoundUI();
        renderCharacters();
        updateHUD();
    }

    function selectMove(type) {
        if (turnInProgress || myMoves.length >= 4 || myMoves.includes(type)) return;
        
        myMoves.push(type);
        document.getElementById(`btn-${type}`).classList.add('selected');
        document.getElementById('move-seq-text').innerText = myMoves.map(m => m.toUpperCase()).join(" > ");

        if (myMoves.length === 4) {
            conn.send({ type: 'moves', moves: myMoves });
            msgEl.innerText = "MENUNGGU LAWAN...";
            checkTurnReady();
        }
    }

    function checkTurnReady() {
        if (myMoves.length === 4 && enemyMoves) {
            msgEl.innerText = "FIGHT!";
            turnInProgress = true;
            setTimeout(processCombat, 1000);
        }
    }

    async function processCombat() {
        msgEl.innerText = "";
        
        for (let i = 0; i < 4; i++) {
            let p1M = isHost ? myMoves[i] : enemyMoves[i];
            let p2M = isHost ? enemyMoves[i] : myMoves[i];

            updatePositionLogically(p1M, p2M);
            
            setAnim(true, p1M);
            setAnim(false, p2M);
            renderCharacters(); 
            
            await wait(400); // Waktu impact

            calculateDamage(p1M, p2M);
            updateHUD();
            handleFX(p1M, p2M);

            await wait(800); // Hold pose

            setAnim(true, 'idle');
            setAnim(false, 'idle');
            await wait(200);

            if (p1Stats.hp <= 0 || p2Stats.hp <= 0) break;
        }
        resolveRound();
    }

    function updatePositionLogically(m1, m2) {
        if (m1 === 'maju' && p1Stats.pos < 5) p1Stats.pos++;
        if (m1 === 'mundur' && p1Stats.pos > 1) p1Stats.pos--;
        if (m2 === 'maju' && p2Stats.pos > 1) p2Stats.pos--;
        if (m2 === 'mundur' && p2Stats.pos < 5) p2Stats.pos++;
    }

    function calculateDamage(m1, m2) {
        const dist = Math.abs(p1Stats.pos - p2Stats.pos);
        const isMelee = dist <= 1;

        if (isMelee) {
            if (m1 === 'attack' && m2 === 'attack') {
                p1Stats.hp -= 10; p1Stats.katana -= 10;
                p2Stats.hp -= 10; p2Stats.katana -= 10;
            } 
            else if (m1 === 'attack' && (m2 === 'maju' || m2 === 'mundur')) p2Stats.hp -= 20;
            else if (m2 === 'attack' && (m1 === 'maju' || m1 === 'mundur')) p1Stats.hp -= 20;
            else if (m1 === 'attack' && m2 === 'tangkis') p1Stats.katana -= 20;
            else if (m2 === 'attack' && m1 === 'tangkis') p2Stats.katana -= 20;
        }

        // Prevent Negative
        p1Stats.hp = Math.max(0, p1Stats.hp); p2Stats.hp = Math.max(0, p2Stats.hp);
        p1Stats.katana = Math.max(0, p1Stats.katana); p2Stats.katana = Math.max(0, p2Stats.katana);
    }

    function handleFX(m1, m2) {
        const dist = Math.abs(p1Stats.pos - p2Stats.pos);
        if (dist <= 1 && ((m1 === 'attack' && m2 === 'tangkis') || (m2 === 'attack' && m1 === 'tangkis'))) {
            sparkEl.classList.add('active');
            setTimeout(() => sparkEl.classList.remove('active'), 300);
        }
    }

    /* --- RENDERING --- */
    const p1El = document.createElement('div');
    const p2El = document.createElement('div');
    p1El.className = 'character owner'; p1El.style.backgroundImage = `url(${ASSETS.idle})`;
    p2El.className = 'character enemy'; p2El.style.backgroundImage = `url(${ASSETS.idle})`;

    function renderCharacters() {
        document.querySelectorAll('.grid-slot').forEach(s => s.innerHTML = '');
        
        let v1 = isHost ? p1Stats.pos : 6 - p1Stats.pos;
        let v2 = isHost ? p2Stats.pos : 6 - p2Stats.pos;

        // Visual Assignment
        // Jika Host: P1=Owner(Biru), P2=Musuh(Merah)
        // Jika Client: P2=Owner(Biru), P1=Musuh(Merah) - Kita swap elemennya di grid
        
        if(isHost) {
            document.getElementById(`grid-${v1}`).appendChild(p1El);
            document.getElementById(`grid-${v2}`).appendChild(p2El);
            p1El.className = 'character owner';
            p2El.className = 'character enemy';
        } else {
            // Di mata Client, P2 adalah diri sendiri (Owner)
            document.getElementById(`grid-${v2}`).appendChild(p2El);
            document.getElementById(`grid-${v1}`).appendChild(p1El);
            p2El.className = 'character owner'; // Client is Owner
            p1El.className = 'character enemy';
        }
    }

    function setAnim(isP1, act) {
        const el = isP1 ? p1El : p2El;
        el.style.backgroundImage = `url(${ASSETS[act] || ASSETS.idle})`;
    }

    function updateHUD() {
        // Logic mapping HUD ke Data
        // HUD Kiri (p1-*) selalu menampilkan "Self"
        // HUD Kanan (p2-*) selalu menampilkan "Enemy"
        
        let selfStats = isHost ? p1Stats : p2Stats;
        let enemyStats = isHost ? p2Stats : p1Stats;

        // Update Self (Kiri)
        updateBar('p1', selfStats);
        // Update Enemy (Kanan)
        updateBar('p2', enemyStats);
    }

    function updateBar(prefix, stats) {
        document.getElementById(`${prefix}-hp-bar`).style.width = stats.hp + '%';
        document.getElementById(`${prefix}-hp-text`).innerText = stats.hp + ' / 100';
        
        document.getElementById(`${prefix}-kt-bar`).style.width = stats.katana + '%';
        document.getElementById(`${prefix}-kt-text`).innerText = 'Pedang: ' + stats.katana + '%';
    }

    async function resolveRound() {
        if (p1Stats.hp <= 0 && p2Stats.hp <= 0) msgEl.innerText = "SERI!";
        else if ((isHost && p2Stats.hp <= 0) || (!isHost && p1Stats.hp <= 0)) msgEl.innerText = "MENANG!";
        else if ((isHost && p1Stats.hp <= 0) || (!isHost && p2Stats.hp <= 0)) msgEl.innerText = "KALAH!";
        else {
            msgEl.innerText = "NEXT ROUND...";
            await wait(2000);
            resetRoundUI();
            return;
        }
        setTimeout(() => location.reload(), 3000);
    }

    function resetRoundUI() {
        myMoves = []; enemyMoves = null; turnInProgress = false;
        msgEl.innerText = "PILIH GERAKAN";
        document.getElementById('move-seq-text').innerText = "...";
        document.querySelectorAll('.move-btn').forEach(b => b.classList.remove('selected'));
    }

    function wait(ms) { return new Promise(r => setTimeout(r, ms)); }
</script>
</body>
</html>
